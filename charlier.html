<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Portal - Competitor Promotion Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Yuji+Boku&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Space Grotesk', sans-serif; background-color: #F8F7F4; background-image: radial-gradient(#D9D9D9 1px, transparent 1px); background-size: 16px 16px; }
        .paper-card { background-color: #FFFFFF; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .font-scribble { font-family: 'Yuji Boku', serif; }
        .notification { transform: translateX(100%); transition: transform 0.3s ease-in-out; position: fixed; top: 1rem; right: 1rem; z-index: 50; }
        .notification.show { transform: translateX(0); }
        .timeline-container { display: flex; background: white; border-radius: 0.5rem; border: 1px solid #e5e7eb; padding-bottom: 10px; }
        .timeline-fixed-col { flex-shrink: 0; width: 200px; background-color: #f9fafb; border-right: 1px solid #e5e7eb; z-index: 10; }
        .timeline-scroll-wrapper { flex-grow: 1; overflow-x: auto; }
        .timeline-header { display: grid; grid-template-columns: repeat(31, 30px); position: sticky; top: 0; z-index: 10; background-color: #6366f1; }
        .timeline-header-label { padding: 8px 4px; text-align: center; font-size: 11px; font-weight: 600; color: white; background-color: #6366f1; border-right: 1px solid #7c7ee8; height: 41px; display: flex; align-items: center; justify-content: center; }
        .timeline-header-label.today { background-color: #ef4444; animation: pulse 2s infinite; }
        .timeline-header-label.weekend { background-color: #4f46e5; }
        .timeline-row { display: grid; grid-template-columns: repeat(31, 30px); min-height: 40px; border-bottom: 1px solid #f3f4f6; position: relative; }
        .timeline-label { padding: 8px 12px; font-size: 13px; font-weight: 500; color: #374151; background-color: #f9fafb; display: flex; align-items: center; border-bottom: 1px solid #f3f4f6; min-height: 40px; }
        .timeline-label.competitor-header { font-weight: 700; font-size: 14px; background-color: #eef2ff; }
        .timeline-bar { position: absolute; height: 28px; top: 6px; border-radius: 4px; display: flex; align-items: center; font-size: 11px; font-weight: 600; color: white; cursor: pointer; transition: all 0.2s ease, width 0.5s ease-out; padding: 0 8px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; width: 0; }
        .timeline-bar:hover { transform: scaleY(1.1); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .timeline-bar.hartono { background: linear-gradient(135deg, #FBBF24, #F59E0B); }
        .timeline-bar.electronic-city { background: linear-gradient(135deg, #60A5FA, #2563EB); }
        .timeline-bar.erablue { background: linear-gradient(135deg, #2DD4BF, #0D9488); }
        .promo-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .promo-card { background-color: #FFFFFF; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); overflow: hidden; display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease; animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        .promo-card:hover { transform: translateY(-8px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .promo-card-header { padding: 1rem; font-size: 1.25rem; font-weight: 700; color: white; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .promo-card-header.hartono { background: linear-gradient(135deg, #FBBF24, #F59E0B); }
        .promo-card-header.electronic-city { background: linear-gradient(135deg, #60A5FA, #2563EB); }
        .promo-card-header.erablue { background: linear-gradient(135deg, #2DD4BF, #0D9488); }
        .promo-card-content { padding: 1rem; flex-grow: 1; }
        .promo-item { display: flex; align-items: flex-start; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed #e5e7eb; position: relative; animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        .promo-item:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .promo-item-icon-container { width: 80px; height: 80px; border-radius: 0.5rem; margin-right: 1rem; flex-shrink: 0; padding: 12px; border: 1px solid #e5e7eb; background-color: #f9fafb; display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease-in-out; }
        .promo-item-icon-container:hover { transform: scale(1.1); }
        .promo-item-icon-container svg { width: 100%; height: 100%; }
        .promo-item-details { flex-grow: 1; }
        .promo-item-title { font-weight: 600; color: #1f2937; margin-bottom: 0.25rem; }
        .promo-item-category { font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem; padding: 0.25rem 0.5rem; background-color: #eef2ff; border-radius: 0.25rem; display: inline-block; }
        .promo-item-description { font-size: 0.875rem; color: #4b5563; }
        .promo-item-actions { position: absolute; top: 0; right: 0; display: flex; gap: 0.25rem; }
        .promo-item-actions button { background: none; border: none; color: #9ca3af; cursor: pointer; padding: 0.25rem; }
        .promo-item-actions button:hover { color: #3b82f6; }
        .promo-item-actions .delete-promo-btn:hover { color: #ef4444; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }
    </style>
</head>
<body class="text-gray-800">
    <div id="notification" class="bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg notification"><span id="notification-text"></span></div>
    <div class="flex flex-col min-h-screen p-4 md:p-8"> <header class="paper-card flex flex-col md:flex-row items-center justify-between p-4 w-full mb-6"> <div class="flex items-center mb-4 md:mb-0"> <svg class="h-8 w-8 mr-2" viewBox="0 0 240 208" xmlns="http://www.w3.org/2000/svg"><path fill="#A1112C" d="M148.2,148.1c-9.3,12.4-26.2,18.6-43.1,18.6c-12.4,0-24.8-4.1-34.2-12.4c-13.4-11.4-20.7-28.8-18.6-46.3c-14.5-7.2-22.8-22.8-20.7-39.4c2.1-16.6,15.5-29.8,32.1-32.9c5.2-20.7,23.8-35.2,45.5-35.2c24.8,0,45.5,18.6,48.6,43.1c16.6,3.1,28.8,16.5,29.8,33.1c1,16.6-7.2,32.1-21.7,40.4C167.8,124.5,160.5,138.8,148.2,148.1z"/><path fill="#D61A3B" d="M211.2,124.5c-9.3,12.4-26.2,18.6-43.1,18.6c-12.4,0-24.8-4.1-34.2-12.4c-13.4-11.4-20.7-28.8-18.6-46.3c-14.5-7.2-22.8-22.8-20.7-39.4c2.1-16.6,15.5-29.8,32.1-32.9c5.2-20.7,23.8-35.2,45.5-35.2c24.8,0,45.5,18.6,48.6,43.1c16.6,3.1,28.8,16.5,29.8,33.1C251.2,125.4,225.7,117.2,211.2,124.5z"/></svg> <h2 class="text-xl font-bold text-gray-900 font-scribble">„ÅÇ„Çå„Å™„Çì„Å†„Å£„Åë</h2> </div> <nav class="flex flex-col md:flex-row items-center gap-2 md:gap-4"> <a href="https://dante19dsc.github.io/analystdante/" target="_blank" rel="noopener noreferrer" class="px-3 py-2 text-sm font-medium rounded-lg text-gray-500 hover:bg-gray-100 w-full md:w-auto text-center">Marketing Information</a> <button class="px-3 py-2 text-sm font-medium rounded-lg text-gray-500 hover:bg-gray-100 w-full md:w-auto">Store Development Map</button> <button class="px-3 py-2 text-sm font-medium rounded-lg bg-gray-100 text-gray-900 w-full md:w-auto">Promotion Tracker</button> </nav> </header> <main class="flex-1 p-4 md:p-8"> <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4"> <div> <h1 class="text-3xl font-bold text-gray-900">Competitor Promotion Tracker</h1> <p class="text-gray-600 mt-2">Monitor and analyze competitor promotional activities in real-time</p> <p id="last-updated-text" class="text-xs text-gray-500 mt-1"></p> </div> <div class="flex gap-2"> <button id="openAddPromoModalBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700"> <i class="fa-solid fa-plus mr-2"></i> Add Promotion </button> </div> </div> <div class="paper-card p-6 mb-8"> <h3 class="text-lg font-semibold text-gray-900 mb-4">August 2025 - Detailed Promotions by Competitor</h3> <div class="timeline-container flex"> <div id="timeline-labels" class="timeline-fixed-col"></div> <div id="timeline-content-scroll" class="timeline-scroll-wrapper"></div> </div> </div> <div class="mb-8"> <h2 class="text-2xl font-bold text-gray-900 mb-6">Current Promotions Overview</h2> <div id="promo-cards-container" class="promo-card-grid"></div> </div> </main> </div>
    <div id="promoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4"><h4 class="text-lg font-bold mb-4">Promotion Details</h4><p id="modal-content" class="text-gray-700 whitespace-pre-wrap"></p><div id="modal-actions" class="mt-6 flex justify-end gap-2"></div></div></div> <div id="deleteConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4"><h4 class="text-lg font-bold mb-2">Confirm Deletion</h4><p class="text-gray-700 mb-6">Are you sure you want to delete this promotion?</p><div class="flex justify-end gap-2"><button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button><button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Yes, Delete</button></div></div></div> <div id="addPromoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full mx-4"><div class="flex justify-between items-center mb-4"><h4 class="text-lg font-bold">Add New Promotion</h4><button onclick="document.getElementById('addPromoModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button></div><form id="addPromoForm" class="space-y-4 mb-4"><div><label for="competitor" class="block text-sm font-medium text-gray-700">Competitor</label><select id="competitor" name="competitor" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="">Select a Competitor</option><option value="Hartono">Hartono</option><option value="Electronic City">Electronic City</option><option value="Erablue">Erablue</option></select></div><div><label for="promoType" class="block text-sm font-medium text-gray-700">Promotion Type</label><select id="promoType" name="promoType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="">Select a Category</option></select></div><div><label for="title" class="block text-sm font-medium text-gray-700">Promotion Title</label><input type="text" id="title" name="title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div><div><label for="promoUrl" class="block text-sm font-medium text-gray-700">Promotion URL</label><input type="url" id="promoUrl" name="promoUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="https://example.com/promo"></div><div class="flex gap-4"><div class="flex-1"><label for="startDate" class="block text-sm font-medium text-gray-700">Start Date</label><input type="date" id="startDate" name="startDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div><div class="flex-1"><label for="endDate" class="block text-sm font-medium text-gray-700">End Date</label><input type="date" id="endDate" name="endDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div></div><div><label for="details" class="block text-sm font-medium text-gray-700">Details</label><textarea id="details" name="details" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea></div><button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700">Add Promotion</button></form></div></div> <div id="editPromoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full mx-4"><div class="flex justify-between items-center mb-4"><h4 class="text-lg font-bold">Edit Promotion</h4><button onclick="document.getElementById('editPromoModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button></div><form id="editPromoForm" class="space-y-4"><input type="hidden" id="editPromoId"><div><label for="editCompetitor" class="block text-sm font-medium text-gray-700">Competitor</label><select id="editCompetitor" name="competitor" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="Hartono">Hartono</option><option value="Electronic City">Electronic City</option><option value="Erablue">Erablue</option></select></div><div><label for="editPromoType" class="block text-sm font-medium text-gray-700">Promotion Type</label><select id="editPromoType" name="promoType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div><div><label for="editTitle" class="block text-sm font-medium text-gray-700">Promotion Title</label><input type="text" id="editTitle" name="title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div><div><label for="editPromoUrl" class="block text-sm font-medium text-gray-700">Promotion URL</label><input type="url" id="editPromoUrl" name="promoUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="https://example.com/promo"></div><div class="flex gap-4"><div class="flex-1"><label for="editStartDate" class="block text-sm font-medium text-gray-700">Start Date</label><input type="date" id="editStartDate" name="startDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div><div class="flex-1"><label for="editEndDate" class="block text-sm font-medium text-gray-700">End Date</label><input type="date" id="editEndDate" name="endDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div></div><div><label for="editDetails" class="block text-sm font-medium text-gray-700">Details</label><textarea id="editDetails" name="details" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea></div><button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700">Save Changes</button></form></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ===================================================================
            // API Configuration - All set up and ready to go!
            // ===================================================================
            const JSONBIN_URL = 'https://api.jsonbin.io/v3/b/68904e27f7e7a370d1f349bb';
            const JSONBIN_API_KEY = '$2a$10$sOSZ5D6cVDPPwJUTty/w0uvrbNINyCukvfWIeW2bv4BhXiQe8jwym';
            // ===================================================================

            // --- GLOBAL STATE ---
            let promotions = [];

            // --- CONFIGURATION DATA ---
            const competitorConfig = { 'Hartono': { colorClass: 'hartono', bgColor: '#FEFCE8' }, 'Electronic City': { colorClass: 'electronic-city', bgColor: '#EFF6FF' }, 'Erablue': { colorClass: 'erablue', bgColor: '#F0FDFA' } };
            const categoryIcons = { 'Promo Bank & Payment': `<svg width="64" height="64" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect x="10" y="25" width="80" height="50" rx="8" fill="#005A9C"/><rect x="10" y="60" width="80" height="5" fill="#7BB8F2"/><rect x="22" y="35" width="15" height="12"rx="2" fill="#F5A623"/></svg>`, 'Promo HP & Gadget': `<svg width="64" height="64" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect x="35" y="15" width="50" height="70" rx="8" fill="#7BB8F2"/><rect x="15" y="25" width="40" height="60" rx="8" fill="#005A9C"/><rect x="20" y="32" width="30" height="46" rx="3" fill="#F5A623"/></svg>`, 'Promo Laptop & PC': `<svg width="64" height="64" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g><path d="M 5 70 L 95 70 L 85 78 L 15 78 Z" fill="#005A9C"/><rect x="18" y="22" width="74" height="48" rx="5" fill="#7BB8F2" transform="skewX(-10)"/><rect x="25" y="28" width="60" height="36" rx="2" fill="#005A9C" transform="skewX(-10)"/></g></svg>`, 'Promo TV & Audio': `<svg width="64" height="64" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect x="8" y="20" width="84" height="50" rx="4" fill="#005A9C"/><rect x="13" y="25" width="74" height="40" fill="#7BB8F2"/><path d="M 45 70 L 55 70 L 65 80 L 35 80 Z" fill="#005A9C"/><rect x="20" y="85" width="60" height="5" rx="2.5" fill="#F5A623"/></svg>`, 'Promo Home Appliances': `<svg width="64" height="64" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g transform="translate(50 35) scale(0.8)"><path d="M 0 -15 L 0 15 M -13 0 L 13 0 M -9 -9 L 9 9 M -9 9 L 9 -9" stroke="#005A9C" stroke-width="4" stroke-linecap="round"/></g><path d="M 25 60 C 25 50, 50 50, 50 75 S 75 90, 75 80 C 75 70, 60 70, 50 85 Z" fill="#7BB8F2" transform="translate(-15 0)"/><g transform="translate(70 70) scale(0.6)"><circle cx="0" cy="0" r="12" fill="none" stroke="#F5A623" stroke-width="4"/><path d="M 0 0 L 10 5" stroke="#F5A623" stroke-width="4" stroke-linecap="round"/><path d="M 0 0 L -10 5" stroke="#F5A623" stroke-width="4" stroke-linecap="round"/><path d="M 0 0 L 0 -12" stroke="#F5A623" stroke-width="4" stroke-linecap="round"/></g></svg>`, 'Promo Back to School': `<svg width="64" height="64" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M 15 80 Q 50 90 85 80 L 85 20 Q 50 10 15 20 Z" fill="#005A9C"/><path d="M 50 22 V 82" stroke="#7BB8F2" stroke-width="4"/><circle cx="50" cy="50" r="12" fill="#F5A623"/><path d="M 50 38 Q 55 35 52 30" stroke="#005A9C" stroke-width="3" fill="none"/></svg>`, 'Promo 17 Agustus': `<svg width="64" height="64" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect x="15" y="10" width="6" height="80" rx="3" fill="#005A9C"/><path d="M 21 25 C 40 15, 60 35, 80 25 V 45 C 60 55, 40 35, 21 45 Z" fill="#F5A623"/><path d="M 21 45 C 40 35, 60 55, 80 45 V 65 C 60 75, 40 55, 21 65 Z" fill="#7BB8F2"/></svg>`, 'Other Promotions': `<svg width="64" height="64" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect x="20" y="40" width="60" height="45" rx="5" fill="#005A9C"/><rect x="15" y="25" width="70" height="15" rx="5" fill="#7BB8F2"/><rect x="45" y="25" width="10" height="60" fill="#F5A623"/><path d="M 45 25 C 35 15, 25 15, 25 25" stroke="#F5A623" stroke-width="8" fill="none"/><path d="M 55 25 C 65 15, 75 15, 75 25" stroke="#F5A623" stroke-width="8" fill="none"/></svg>` };
            const promoCategories = [ 'Promo Bank & Payment', 'Promo HP & Gadget', 'Promo Laptop & PC', 'Promo TV & Audio', 'Promo Home Appliances', 'Promo Back to School', 'Promo 17 Agustus', 'Other Promotions' ];

            // --- DATA PROCESSING & UTILITY FUNCTIONS ---
            const getPromoCategory = (promo) => { const text = (promo.title + ' ' + (promo.details || '')).toLowerCase(); if (text.includes('bank') || text.includes('credit card') || text.includes('cicilan')) return 'Promo Bank & Payment'; if (text.includes('hp') || text.includes('galaxy') || text.includes('tecno') || text.includes('oppo')) return 'Promo HP & Gadget'; if (text.includes('laptop') || text.includes('back to school')) return 'Promo Laptop & PC'; if (text.includes('tv') || text.includes('audio')) return 'Promo TV & Audio'; if (text.includes('ac ') || text.includes('air conditioner')) return 'Promo Home Appliances'; if (text.includes('pahlawan') || text.includes('17 agustus')) return 'Promo 17 Agustus'; return 'Other Promotions'; };
            const getCategoryIcon = (category) => categoryIcons[category] || categoryIcons['Other Promotions'];
            
            const calculatePromotionSpan = (startDate, endDate) => {
                // By appending 'T00:00:00Z', we tell the Date constructor to parse the date as UTC.
                // This avoids timezone-related bugs where the date could be interpreted as the previous day.
                const d = (dateString) => new Date(dateString + 'T00:00:00Z');
                const start = d(startDate);
                const end = d(endDate);

                const augStart = new Date('2025-08-01T00:00:00Z');
                const augEnd = new Date('2025-08-31T23:59:59Z');

                let s = start < augStart ? augStart : start;
                let e = end > augEnd ? augEnd : end;

                if (s > e) return {startDay: -1, duration: 0};

                // getUTCDate() is now safe to use because we parsed the dates as UTC.
                return { startDay: s.getUTCDate(), duration: e.getUTCDate() - s.getUTCDate() + 1 };
            };
            
            // --- API & DATA HANDLING ---
            async function loadPromotions() {
                try {
                    const response = await fetch(`${JSONBIN_URL}/latest`, { headers: { 'X-Master-Key': JSONBIN_API_KEY } });
                    if (!response.ok) { 
                        showNotification('‚ùå Error loading data from server.', 'bg-red-500'); 
                        return; 
                    }
                    const data = await response.json();
                    let loadedPromotions = data.record || [];
                    
                    // **FIX**: Process data to add category and icon
                    promotions = loadedPromotions.map((p, index) => {
                        const category = p.category || getPromoCategory(p);
                        return {
                            ...p,
                            tempId: index,
                            category: category,
                            iconHTML: getCategoryIcon(category)
                        };
                    });

                    rerenderAll();
                } catch (error) {
                    console.error("Failed to load promotions:", error);
                    showNotification('‚ùå Network error. Could not load data.', 'bg-red-500');
                }
            }

            async function saveData(updatedPromotions) {
                // Remove temporary client-side properties before saving
                const dataToSave = updatedPromotions.map(({ tempId, iconHTML, ...rest }) => rest);
                try {
                    const response = await fetch(JSONBIN_URL, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_API_KEY },
                        body: JSON.stringify(dataToSave)
                    });
                    return response.ok;
                } catch (error) {
                    console.error("Failed to save data:", error);
                    showNotification('‚ùå Network error. Could not save data.', 'bg-red-500');
                    return false;
                }
            }

            // --- FORM HANDLERS ---
            const handleAddPromoForm = async (event) => {
                event.preventDefault();
                const form = event.target;
                const newPromo = { 
                    competitor: form.competitor.value, 
                    title: form.title.value, 
                    startDate: form.startDate.value, 
                    endDate: form.endDate.value, 
                    details: form.details.value, 
                    url: form.promoUrl.value,
                    category: form.promoType.value // Get category from form
                };
                const updatedPromotions = [...promotions, newPromo];
                const success = await saveData(updatedPromotions);
                if (success) {
                    showNotification('‚úÖ New promotion added!', 'bg-green-500');
                    form.reset();
                    document.getElementById('addPromoModal').classList.add('hidden');
                    await loadPromotions();
                } else { showNotification('‚ùå Failed to add promotion.', 'bg-red-500'); }
            };
            
            const handleEditPromoForm = async (event) => {
                event.preventDefault();
                const form = event.target;
                const promoId = parseInt(form.editPromoId.value);
                const updatedPromotions = promotions.map(p => {
                    if (p.tempId === promoId) {
                        return { 
                            tempId: p.tempId, 
                            competitor: document.getElementById('editCompetitor').value, 
                            title: document.getElementById('editTitle').value, 
                            url: document.getElementById('editPromoUrl').value, 
                            startDate: document.getElementById('editStartDate').value, 
                            endDate: document.getElementById('editEndDate').value, 
                            details: document.getElementById('editDetails').value,
                            category: document.getElementById('editPromoType').value
                        };
                    }
                    return p;
                });
                const success = await saveData(updatedPromotions);
                if (success) {
                    showNotification('‚úèÔ∏è Promotion updated.', 'bg-green-500');
                    document.getElementById('editPromoModal').classList.add('hidden');
                    await loadPromotions();
                } else { showNotification('‚ùå Failed to update.', 'bg-red-500'); }
            };

            const deletePromotion = async (promoId) => {
                const updatedPromotions = promotions.filter(p => p.tempId !== promoId);
                const success = await saveData(updatedPromotions);
                if (success) {
                    showNotification('üóëÔ∏è Promotion deleted.', 'bg-blue-500');
                    document.getElementById('deleteConfirmModal').classList.add('hidden');
                    document.getElementById('promoModal').classList.add('hidden');
                    await loadPromotions();
                } else { showNotification('‚ùå Failed to delete.', 'bg-red-500'); }
            };
            
            // --- UI RENDERING FUNCTIONS ---
            const createTimeline = () => {
                const labelContainer = document.getElementById('timeline-labels');
                const scrollContainer = document.getElementById('timeline-content-scroll');
                if (!labelContainer || !scrollContainer) return;
                labelContainer.innerHTML = '';
                scrollContainer.innerHTML = '';
                const competitors = ['Hartono', 'Electronic City', 'Erablue'];
                const fixedHeader = document.createElement('div');
                fixedHeader.className = 'timeline-label sticky top-0 bg-[#4f46e5] text-white font-bold';
                fixedHeader.style.zIndex = 11;
                fixedHeader.style.height = '41px';
                fixedHeader.textContent = 'AUGUST 2025';
                labelContainer.appendChild(fixedHeader);
                const header = document.createElement('div');
                header.className = 'timeline-header';
                let headerHTML = '';
                const today = new Date();
                const currentDayOfMonth = today.getDate();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                for (let day = 1; day <= 31; day++) {
                    let specialClass = '';
                    const dateInLoop = new Date(Date.UTC(2025, 7, day));
                    const dayOfWeek = dateInLoop.getUTCDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) specialClass = 'weekend';
                    if (day === currentDayOfMonth && currentMonth === 7 && currentYear === 2025) specialClass += ' today';
                    headerHTML += `<div class="timeline-header-label ${specialClass.trim()}">${day}</div>`;
                }
                header.innerHTML = headerHTML;
                scrollContainer.appendChild(header);
                
                const groupedPromos = {};
                promotions.forEach(p => {
                    if (!groupedPromos[p.competitor]) groupedPromos[p.competitor] = {};
                    if (!groupedPromos[p.competitor][p.category]) groupedPromos[p.competitor][p.category] = [];
                    groupedPromos[p.competitor][p.category].push(p);
                });

                competitors.forEach(compName => {
                    const config = competitorConfig[compName];
                    const competitorLabel = document.createElement('div');
                    competitorLabel.className = 'timeline-label competitor-header';
                    competitorLabel.textContent = compName;
                    labelContainer.appendChild(competitorLabel);
                    const competitorRow = document.createElement('div');
                    competitorRow.className = 'timeline-row';
                    competitorRow.style.backgroundColor = config.bgColor;
                    scrollContainer.appendChild(competitorRow);

                    const competitorPromos = groupedPromos[compName] || {};
                    promoCategories.forEach(catName => {
                        const promosForCategory = competitorPromos[catName] || [];
                        if (promosForCategory.length > 0) {
                             const categoryLabel = document.createElement('div');
                             categoryLabel.className = 'timeline-label';
                             categoryLabel.textContent = catName;
                             labelContainer.appendChild(categoryLabel);

                             const categoryRow = document.createElement('div');
                             categoryRow.className = 'timeline-row';
                             scrollContainer.appendChild(categoryRow);

                             promosForCategory.forEach(promo => {
                                 const span = calculatePromotionSpan(promo.startDate, promo.endDate);
                                 if (span.duration > 0) {
                                     const bar = document.createElement('div');
                                     bar.className = `timeline-bar ${config.colorClass}`;
                                     bar.style.left = `${(span.startDay - 1) * 30 + 2}px`;
                                     setTimeout(() => { bar.style.width = `${span.duration * 30 - 4}px`; }, 50);
                                     bar.textContent = promo.title;
                                     bar.dataset.promoId = promo.tempId;
                                     bar.onclick = () => showPromoDetailsModal(promo.tempId);
                                     categoryRow.appendChild(bar);
                                 }
                             });
                        }
                    });
                });
            };

            const renderPromotionCards = () => {
                const container = document.getElementById('promo-cards-container');
                if (!container) return;
                container.innerHTML = '';
                const competitors = ['Hartono', 'Electronic City', 'Erablue'];
                competitors.forEach(compName => {
                    const compPromotions = promotions.filter(p => p.competitor === compName);
                    if (compPromotions.length === 0) return;
                    const card = document.createElement('div');
                    card.className = 'promo-card';
                    card.innerHTML = `<div class="promo-card-header ${competitorConfig[compName].colorClass}">${compName} Promotions</div><div class="promo-card-content" id="promo-content-${compName.replace(/\s/g, '')}"></div>`;
                    container.appendChild(card);
                    const contentDiv = document.getElementById(`promo-content-${compName.replace(/\s/g, '')}`);
                    compPromotions.forEach((promo, index) => {
                        const promoItem = document.createElement('div');
                        promoItem.className = 'promo-item';
                        promoItem.style.animationDelay = `${index * 50}ms`;
                        promoItem.innerHTML = `<a href="${promo.url || '#'}" target="_blank" rel="noopener noreferrer" title="Kunjungi halaman promosi"><div class="promo-item-icon-container">${promo.iconHTML}</div></a><div class="promo-item-details"><div class="promo-item-title">${promo.title}</div><div class="promo-item-category">${promo.category}</div><p class="promo-item-description">${promo.details || 'No details provided.'}</p><p class="promo-item-description text-xs text-gray-500 mt-2">${promo.startDate} - ${promo.endDate}</p></div><div class="promo-item-actions"><button class="edit-promo-btn" data-promo-id="${promo.tempId}" title="Edit Promotion"><i class="fa-solid fa-pencil"></i></button><button class="delete-promo-btn" data-promo-id="${promo.tempId}" title="Delete Promotion"><i class="fa-solid fa-trash-can"></i></button></div>`;
                        contentDiv.appendChild(promoItem);
                    });
                });
                document.querySelectorAll('.edit-promo-btn').forEach(button => button.addEventListener('click', (e) => showEditPromoModal(parseInt(e.currentTarget.dataset.promoId))));
                document.querySelectorAll('.delete-promo-btn').forEach(button => button.addEventListener('click', (e) => showDeleteConfirmModal(parseInt(e.currentTarget.dataset.promoId))));
            };

            const rerenderAll = () => {
                createTimeline();
                renderPromotionCards();
                updateLastUpdatedText();
            };

            // --- MODAL & NOTIFICATION FUNCTIONS ---
            const showPromoDetailsModal = (promoId) => { const promo = promotions.find(p => p.tempId === promoId); if (!promo) return; const modal = document.getElementById('promoModal'); document.getElementById('modal-content').textContent = `[${promo.category}] ${promo.title}\n\nDetails: ${promo.details}\nDuration: ${promo.startDate} to ${promo.endDate}`; const modalActions = document.getElementById('modal-actions'); modalActions.innerHTML = ''; const deleteButton = document.createElement('button'); deleteButton.className = 'px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700'; deleteButton.textContent = 'Delete'; deleteButton.onclick = () => showDeleteConfirmModal(promo.tempId); const closeButton = document.createElement('button'); closeButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300'; closeButton.textContent = 'Close'; closeButton.onclick = () => document.getElementById('promoModal').classList.add('hidden'); modalActions.appendChild(deleteButton); modalActions.appendChild(closeButton); modal.classList.remove('hidden'); };
            const showDeleteConfirmModal = (promoId) => { const confirmModal = document.getElementById('deleteConfirmModal'); document.getElementById('confirmDeleteBtn').dataset.promoId = promoId; confirmModal.classList.remove('hidden'); };
            const showEditPromoModal = (promoId) => { const promo = promotions.find(p => p.tempId === promoId); if (!promo) return; const modal = document.getElementById('editPromoModal'); document.getElementById('editPromoId').value = promo.tempId; document.getElementById('editCompetitor').value = promo.competitor; document.getElementById('editPromoType').value = promo.category; document.getElementById('editTitle').value = promo.title; document.getElementById('editPromoUrl').value = promo.url || ''; document.getElementById('editStartDate').value = promo.startDate; document.getElementById('editEndDate').value = promo.endDate; document.getElementById('editDetails').value = promo.details; modal.classList.remove('hidden'); };
            const populatePromoTypeDropdowns = () => { const selects = [document.getElementById('promoType'), document.getElementById('editPromoType')]; selects.forEach(select => { if (!select) return; select.innerHTML = '<option value="">Select a Category</option>'; promoCategories.forEach(category => { const option = document.createElement('option'); option.value = category; option.textContent = category; select.appendChild(option); }); }); };
            const showNotification = (message, colorClass = 'bg-green-500') => { const notification = document.getElementById('notification'); const notificationText = document.getElementById('notification-text'); notificationText.textContent = message; notification.className = `text-white px-4 py-2 rounded-lg shadow-lg notification ${colorClass}`; notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), 3000); };
            const updateLastUpdatedText = () => { const lastUpdatedElement = document.getElementById('last-updated-text'); const now = new Date(); const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }; lastUpdatedElement.textContent = `Last updated: ${now.toLocaleDateString('en-US', options)}`; };
            
            // --- INITIALIZATION AND EVENT LISTENERS ---
            populatePromoTypeDropdowns();
            document.getElementById('openAddPromoModalBtn').addEventListener('click', () => { document.getElementById('addPromoModal').classList.remove('hidden'); });
            document.getElementById('addPromoForm').addEventListener('submit', handleAddPromoForm);
            document.getElementById('editPromoForm').addEventListener('submit', handleEditPromoForm);
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => { document.getElementById('deleteConfirmModal').classList.add('hidden'); });
            document.getElementById('confirmDeleteBtn').addEventListener('click', (e) => { const promoId = parseInt(e.currentTarget.dataset.promoId); deletePromotion(promoId); });

            // --- START THE APPLICATION ---
            loadPromotions();
        });
    </script>
</body>
</html>
